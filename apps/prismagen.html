<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PrismaGen AI - Celestial Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX/TSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Space Grotesk', 'sans-serif'],
            },
            colors: {
              astro: {
                900: '#02040a', // Deep void
                800: '#0B0F1A', // Space dark
                700: '#151b2e', // Nebula dark
              },
              bio: {
                primary: '#6366f1', // Indigo
                secondary: '#a855f7', // Purple
                accent: '#22d3ee', // Cyan
                glow: '#8b5cf6', // Violet Glow
              }
            },
            animation: {
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 6s ease-in-out infinite',
              'shimmer': 'shimmer 2.5s linear infinite',
              'glow': 'glow 2s ease-in-out infinite alternate',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-10px)' },
              },
              shimmer: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(100%)' },
              },
              glow: {
                'from': { boxShadow: '0 0 10px #4f46e5, 0 0 20px #818cf8' },
                'to': { boxShadow: '0 0 20px #4f46e5, 0 0 30px #818cf8' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Global Styles -->
    <style>
      body {
        background-color: #02040a;
        color: #e2e8f0;
        overflow-x: hidden;
      }
      
      /* Starfield Background */
      .stars, .twinkling {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        display: block;
      }
      
      .stars {
        background: #000 url('https://raw.githubusercontent.com/ProgrammingCode/stars-twinkling-css-animation/master/stars.png') repeat top center;
        z-index: -2;
      }
      
      .twinkling {
        background: transparent url('https://raw.githubusercontent.com/ProgrammingCode/stars-twinkling-css-animation/master/twinkling.png') repeat top center;
        z-index: -1;
        animation: move-twink-back 200s linear infinite;
        opacity: 0.4;
      }

      @keyframes move-twink-back {
        from {background-position:0 0;}
        to {background-position:-10000px 5000px;}
      }

      /* Custom Scrollbar for Glass UI */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05); 
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.5); 
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(34, 211, 238, 0.7); 
      }
      
      .glass-panel {
        background: rgba(11, 15, 26, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      }
      
      .glass-input {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .glass-input:focus {
        border-color: #a855f7;
        box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
      }
      .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
      }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
    
    <!-- Polyfill for process.env -->
    <script>
      window.process = {
        env: {
          API_KEY: '' // User will supply this via UI or console if needed
        }
      };
    </script>
  </head>
  <body>
    <div id="root"></div>
    <!-- Stars Background Elements -->
    <div class="stars"></div>
    <div class="twinkling"></div>
    
    <!-- Application Script -->
    <script type="text/babel" data-type="module">
      import { GoogleGenAI } from "@google/genai";
      
      const { useState, useEffect, useRef } = React;

      // --- TYPES & ENUMS ---
      const AspectRatio = {
        Square: "1:1",
        Portrait: "9:16",
        Landscape: "16:9",
        Wide: "4:3",
        Tall: "3:4"
      };

      // --- CONSTANTS ---
      const STYLES = [
        {
          id: 'none',
          name: 'No Style',
          promptModifier: '',
          icon: 'âœ¨',
          color: 'from-gray-500 to-gray-700'
        },
        {
          id: 'photorealistic',
          name: 'Photorealistic',
          promptModifier: 'highly detailed, photorealistic, 8k resolution, cinematic lighting, sharp focus, raw photo',
          icon: 'ðŸ“¸',
          color: 'from-blue-500 to-cyan-500'
        },
        {
          id: 'anime',
          name: 'Anime',
          promptModifier: 'anime style, studio ghibli, vibrant colors, cel shaded, detailed background',
          icon: 'ðŸŒ¸',
          color: 'from-pink-500 to-rose-500'
        },
        {
          id: 'cyberpunk',
          name: 'Cyberpunk',
          promptModifier: 'cyberpunk, neon lights, futuristic city, high tech, sci-fi, synthwave aesthetic',
          icon: 'ðŸ¦¾',
          color: 'from-purple-600 to-blue-600'
        },
        {
          id: 'oil_painting',
          name: 'Oil Painting',
          promptModifier: 'oil painting texture, visible brushstrokes, classic art style, masterwork, rich colors',
          icon: 'ðŸŽ¨',
          color: 'from-amber-600 to-orange-600'
        },
        {
          id: '3d_render',
          name: '3D Render',
          promptModifier: '3d render, unreal engine 5, octane render, ray tracing, physically based rendering, volumetric lighting',
          icon: 'ðŸ§Š',
          color: 'from-emerald-500 to-teal-500'
        },
        {
          id: 'pixel_art',
          name: 'Pixel Art',
          promptModifier: 'pixel art, 16-bit, retro game style, sprite art, clean lines',
          icon: 'ðŸ‘¾',
          color: 'from-indigo-500 to-violet-500'
        },
        {
          id: 'watercolor',
          name: 'Watercolor',
          promptModifier: 'watercolor painting, soft edges, artistic, pastel colors, wet-on-wet technique',
          icon: 'ðŸ’§',
          color: 'from-cyan-400 to-blue-400'
        },
        {
          id: 'fantasy',
          name: 'Fantasy',
          promptModifier: 'fantasy art, dungeons and dragons style, magic, ethereal, detailed armor, epic atmosphere',
          icon: 'ðŸ‰',
          color: 'from-red-600 to-red-800'
        },
        {
          id: 'line_art',
          name: 'Line Art',
          promptModifier: 'line art, black and white, ink illustration, minimalism, clean contours',
          icon: 'âœ’ï¸',
          color: 'from-gray-100 to-gray-300'
        },
        {
          id: 'steampunk',
          name: 'Steampunk',
          promptModifier: 'steampunk style, brass and copper gears, steam engine aesthetics, victorian industrial, sepia tones, intricate mechanical details',
          icon: 'âš™ï¸',
          color: 'from-amber-700 to-yellow-900'
        },
        {
          id: 'papercraft',
          name: 'Papercraft',
          promptModifier: 'papercraft style, layered paper cutout, origami, depth of field, 3d paper art, craft aesthetic, soft shadows',
          icon: 'âœ‚ï¸',
          color: 'from-orange-400 to-amber-200'
        },
        {
          id: 'pop_art',
          name: 'Pop Art',
          promptModifier: 'pop art style, roy lichtenstein, andy warhol, ben-day dots, bold outlines, vibrant primary colors, comic book aesthetic',
          icon: 'ðŸ’¥',
          color: 'from-yellow-400 to-pink-500'
        },
        {
          id: 'synthwave',
          name: 'Synthwave',
          promptModifier: 'synthwave style, retrowave, 80s aesthetic, neon grids, purple and cyan gradient, retro-futuristic, vhs glitch',
          icon: 'ðŸŒ‡',
          color: 'from-fuchsia-600 to-purple-800'
        },
        {
          id: 'ukiyo_e',
          name: 'Ukiyo-e',
          promptModifier: 'ukiyo-e style, japanese woodblock print, hokusai style, flat perspective, traditional patterns, muted earth tones',
          icon: 'ðŸŒŠ',
          color: 'from-blue-700 to-indigo-900'
        },
        {
          id: 'low_poly',
          name: 'Low Poly',
          promptModifier: 'low poly style, geometric shapes, minimal details, flat shading, isometric view, polygon art',
          icon: 'ðŸ”·',
          color: 'from-lime-500 to-green-600'
        },
        {
          id: 'graffiti',
          name: 'Graffiti',
          promptModifier: 'graffiti art style, street art, spray paint texture, vibrant urban colors, drip effects, wildstyle lettering',
          icon: 'ðŸ›¹',
          color: 'from-yellow-500 to-red-500'
        },
        {
          id: 'surrealism',
          name: 'Surrealism',
          promptModifier: 'surrealism style, salvador dali, rene magritte, dreamlike atmosphere, melting objects, impossible geometry',
          icon: 'ðŸ‘ï¸',
          color: 'from-sky-300 to-indigo-400'
        },
        {
          id: 'pencil_sketch',
          name: 'Pencil Sketch',
          promptModifier: 'pencil sketch, graphite drawing, rough charcoal lines, shading, hand-drawn texture, monochrome',
          icon: 'âœï¸',
          color: 'from-gray-400 to-gray-600'
        },
        {
          id: 'claymation',
          name: 'Claymation',
          promptModifier: 'claymation style, plasticine texture, stop motion look, aardman style, soft lighting, tactile feel',
          icon: 'ðŸ—¿',
          color: 'from-orange-300 to-red-400'
        },
        {
          id: 'noir',
          name: 'Film Noir',
          promptModifier: 'film noir style, high contrast black and white, dramatic shadows, chiaroscuro lighting, detective mystery atmosphere',
          icon: 'ðŸ•µï¸',
          color: 'from-gray-800 to-black'
        },
        {
          id: 'stained_glass',
          name: 'Stained Glass',
          promptModifier: 'stained glass window style, vibrant light passing through glass, black lead lines, mosaic pattern, cathedral atmosphere',
          icon: 'ðŸªŸ',
          color: 'from-blue-500 to-yellow-500'
        },
        {
          id: 'glitch_art',
          name: 'Glitch Art',
          promptModifier: 'glitch art style, digital distortion, vhs static, datamoshing, pixel sorting, chromatic aberration',
          icon: 'ðŸ“º',
          color: 'from-pink-600 to-cyan-600'
        },
        {
          id: 'isometric',
          name: 'Isometric',
          promptModifier: 'isometric style, 3d isometric view, clean vector graphics, sims style, detailed, diorama',
          icon: 'ðŸ“¦',
          color: 'from-blue-300 to-indigo-400'
        },
        {
          id: 'sticker',
          name: 'Sticker Art',
          promptModifier: 'sticker art, white outline, die-cut, vector style, cute, flat color, sticker bomb',
          icon: 'ðŸ·ï¸',
          color: 'from-yellow-300 to-orange-400'
        },
        {
          id: 'psychedelic',
          name: 'Psychedelic',
          promptModifier: 'psychedelic art, trippy colors, swirling patterns, hallucinogenic, vibrant, detailed, lsd art style',
          icon: 'ðŸ„',
          color: 'from-pink-400 to-green-400'
        },
        {
          id: 'blueprint',
          name: 'Blueprint',
          promptModifier: 'blueprint style, technical drawing, cyanotype, white lines on blue background, schematic, engineering diagram',
          icon: 'ðŸ“',
          color: 'from-blue-800 to-blue-600'
        },
        {
          id: 'vector_flat',
          name: 'Flat Vector',
          promptModifier: 'flat vector art, adobe illustrator style, clean shapes, minimal, solid colors, corporate art style',
          icon: 'ðŸ”·',
          color: 'from-teal-400 to-cyan-300'
        }
      ];

      const ASPECT_RATIOS = [
        { value: AspectRatio.Square, label: "Square (1:1)" },
        { value: AspectRatio.Landscape, label: "Landscape (16:9)" },
        { value: AspectRatio.Portrait, label: "Portrait (9:16)" },
        { value: AspectRatio.Wide, label: "Wide (4:3)" },
        { value: AspectRatio.Tall, label: "Tall (3:4)" },
      ];

      // --- GEMINI SERVICE ---
      const getAIInstance = () => {
        // Fallback to empty string if undefined to avoid crashing on init
        const key = window.process?.env?.API_KEY || '';
        return new GoogleGenAI({ apiKey: key });
      };

      const generateImageWithGemini = async (config) => {
        const { prompt, styleId, aspectRatio, referenceImage, referenceImageMimeType } = config;

        const modelName = 'gemini-2.5-flash-image';
        
        const selectedStyle = STYLES.find(s => s.id === styleId);
        const finalPrompt = selectedStyle && selectedStyle.id !== 'none'
          ? `${prompt}. Style: ${selectedStyle.promptModifier}`
          : prompt;

        const ai = getAIInstance();

        try {
          const parts = [];

          if (referenceImage && referenceImageMimeType) {
            parts.push({
              inlineData: {
                data: referenceImage,
                mimeType: referenceImageMimeType,
              },
            });
          }

          parts.push({ text: finalPrompt });

          const imageConfig = {
            aspectRatio: aspectRatio,
          };

          const response = await ai.models.generateContent({
            model: modelName,
            contents: {
              parts: parts,
            },
            config: {
              imageConfig: imageConfig
            },
          });

          if (response.candidates && response.candidates.length > 0) {
            const content = response.candidates[0].content;
            if (content && content.parts) {
              for (const part of content.parts) {
                if (part.inlineData && part.inlineData.data) {
                  const base64Data = part.inlineData.data;
                  const mimeType = part.inlineData.mimeType || 'image/png';
                  return `data:${mimeType};base64,${base64Data}`;
                }
              }
            }
          }

          throw new Error("No image data found in the response. The model might have refused the prompt.");

        } catch (error) {
          console.error("Gemini Image Generation Error:", error);
          throw error;
        }
      };

      // --- COMPONENTS ---

      // StyleCard
      const StyleCard = ({ style, isSelected, onSelect }) => {
        return (
          <div
            onClick={() => onSelect(style.id)}
            className={`
              relative overflow-hidden cursor-pointer rounded-xl transition-all duration-500
              border group h-24 flex items-center justify-center flex-col gap-2 backdrop-blur-md
              ${isSelected 
                ? 'border-bio-accent/80 bg-astro-800/80 shadow-[0_0_20px_rgba(34,211,238,0.3)] scale-105 z-10' 
                : 'border-white/5 bg-astro-900/40 hover:bg-astro-800/60 hover:border-bio-secondary/50 hover:shadow-[0_0_15px_rgba(168,85,247,0.2)]'}
            `}
          >
            <div className={`absolute inset-0 bg-gradient-to-br ${style.color} opacity-0 group-hover:opacity-20 transition-opacity duration-500`} />
            {isSelected && (
              <div className="absolute inset-0 bg-gradient-to-b from-transparent to-bio-accent/10" />
            )}
            
            <span className={`text-3xl z-10 transition-transform duration-300 ${isSelected ? 'scale-110 drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]' : 'group-hover:scale-110 grayscale group-hover:grayscale-0'}`}>
              {style.icon}
            </span>
            
            <span className={`text-[10px] font-display font-bold uppercase tracking-widest z-10 transition-colors ${isSelected ? 'text-bio-accent' : 'text-gray-500 group-hover:text-gray-300'}`}>
              {style.name}
            </span>
            
            {isSelected && (
              <div className="absolute top-2 right-2 w-1.5 h-1.5 bg-bio-accent rounded-full shadow-[0_0_5px_#22d3ee] animate-pulse" />
            )}
          </div>
        );
      };

      // ImageUploader
      const ImageUploader = ({ previewUrl, onImageSelect }) => {
        const fileInputRef = useRef(null);
        const [isDragging, setIsDragging] = useState(false);

        const handleFileChange = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            onImageSelect(file);
          }
        };

        const handleDragOver = (e) => {
          e.preventDefault();
          setIsDragging(true);
        };

        const handleDragLeave = (e) => {
          e.preventDefault();
          setIsDragging(false);
        };

        const handleDrop = (e) => {
          e.preventDefault();
          setIsDragging(false);
          const file = e.dataTransfer.files?.[0];
          if (file && file.type.startsWith('image/')) {
            onImageSelect(file);
          }
        };

        const handleClear = () => {
          onImageSelect(null);
          if (fileInputRef.current) {
            fileInputRef.current.value = '';
          }
        };

        return (
          <div className="w-full">
            <label className="text-xs font-bold text-bio-accent uppercase tracking-[0.2em] mb-2 block ml-1 text-shadow-glow">
              Reference Signal (Optional)
            </label>
            
            {!previewUrl ? (
              <div
                onClick={() => fileInputRef.current?.click()}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                className={`
                  relative w-full h-32 rounded-2xl border border-dashed transition-all cursor-pointer flex flex-col items-center justify-center gap-3 group overflow-hidden
                  ${isDragging 
                    ? 'border-bio-accent bg-bio-accent/10 shadow-[0_0_20px_rgba(34,211,238,0.2)]' 
                    : 'border-white/20 bg-astro-800/50 hover:bg-astro-800/80 hover:border-bio-primary/50'}
                `}
              >
                <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:20px_20px] opacity-20 pointer-events-none"></div>

                <div className="w-12 h-12 rounded-full bg-astro-900 border border-white/10 flex items-center justify-center text-bio-primary group-hover:text-bio-accent group-hover:border-bio-accent/50 group-hover:scale-110 transition-all shadow-[0_0_15px_rgba(99,102,241,0.2)]">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </div>
                <p className="text-[10px] text-gray-400 font-mono group-hover:text-bio-accent transition-colors uppercase tracking-wider">
                  {isDragging ? 'RELEASE TO UPLOAD' : 'INITIATE UPLOAD'}
                </p>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleFileChange}
                  className="hidden"
                />
              </div>
            ) : (
              <div className="relative w-full h-48 rounded-2xl overflow-hidden border border-bio-accent/30 group shadow-[0_0_20px_rgba(34,211,238,0.15)]">
                <img 
                  src={previewUrl} 
                  alt="Reference" 
                  className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                />
                <div className="absolute inset-0 w-full h-[2px] bg-bio-accent/80 shadow-[0_0_10px_#22d3ee] animate-[scan_2s_linear_infinite] opacity-50 pointer-events-none"></div>

                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-sm">
                  <button
                      type="button"
                      onClick={handleClear}
                      className="bg-red-500/20 hover:bg-red-500 text-red-300 hover:text-white p-3 rounded-full backdrop-blur-md transition-all border border-red-500/50 hover:shadow-[0_0_20px_rgba(239,68,68,0.6)]"
                  >
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div className="absolute top-2 left-2 px-2 py-1 bg-black/60 backdrop-blur-md rounded border border-white/10 flex items-center gap-2">
                  <div className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></div>
                  <span className="text-[9px] text-white font-mono uppercase tracking-widest">Signal Locked</span>
                </div>
              </div>
            )}
          </div>
        );
      };

      // Controls
      const Controls = ({ aspectRatio, setAspectRatio }) => {
        return (
          <div className="flex flex-col gap-6 glass-panel p-5 rounded-2xl">
            <div>
              <label className="text-xs font-bold text-bio-accent uppercase tracking-[0.2em] mb-3 block text-shadow-glow">
                Dimensions
              </label>
              <div className="grid grid-cols-3 gap-2">
                {ASPECT_RATIOS.map((option) => (
                  <button
                    type="button"
                    key={option.value}
                    onClick={() => setAspectRatio(option.value)}
                    className={`
                      relative overflow-hidden text-[10px] font-mono py-2.5 px-1 rounded-lg border transition-all duration-300 uppercase tracking-wide
                      ${aspectRatio === option.value
                        ? 'bg-bio-primary/20 border-bio-primary text-white shadow-[0_0_10px_rgba(99,102,241,0.3)]'
                        : 'bg-transparent border-white/5 text-gray-500 hover:border-white/20 hover:text-gray-300 hover:bg-white/5'}
                    `}
                  >
                    {aspectRatio === option.value && (
                      <div className="absolute inset-0 bg-gradient-to-b from-transparent via-white/5 to-transparent opacity-30 animate-pulse-slow"></div>
                    )}
                    {option.label}
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      };

      // Gallery
      const Gallery = ({ images, onDownload, onDelete, onClearAll }) => {
        const [selectedImage, setSelectedImage] = useState(null);

        return (
          <div className="h-full flex flex-col relative z-10">
            <div className="flex items-center justify-between mb-8 pb-4 border-b border-white/5 relative z-20">
              <h2 className="text-2xl font-display font-bold text-white flex items-center gap-3">
                <span className="text-bio-accent drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">///</span> 
                ARCHIVE
              </h2>
              
              <div className="flex items-center gap-4">
                {images.length > 0 && (
                  <button 
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      onClearAll();
                    }}
                    className="cursor-pointer text-[10px] uppercase tracking-widest text-red-400 hover:text-red-300 hover:bg-red-900/20 px-3 py-1.5 rounded border border-transparent hover:border-red-500/30 transition-all flex items-center gap-2 font-bold z-30"
                    title="Purge System"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    PURGE ALL
                  </button>
                )}
                <div className="text-xs text-bio-secondary font-mono px-3 py-1 bg-bio-secondary/10 rounded-full border border-bio-secondary/20">
                  COUNT: {images.length.toString().padStart(2, '0')}
                </div>
              </div>
            </div>

            {images.length === 0 ? (
              <div className="flex-1 flex flex-col items-center justify-center text-center opacity-60">
                <div className="w-24 h-24 rounded-full border border-dashed border-white/10 flex items-center justify-center mb-6 animate-spin-slow">
                  <div className="w-16 h-16 rounded-full bg-bio-primary/5 blur-xl animate-pulse"></div>
                </div>
                <p className="text-xl font-display text-gray-400 mb-2">VOID DETECTED</p>
                <p className="text-sm font-mono text-gray-600">Initiate synthesis protocol to populate grid.</p>
              </div>
            ) : (
              <div className="columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6 pb-20">
                {images.map((img) => (
                  <div 
                    key={img.id} 
                    className="break-inside-avoid group relative rounded-xl overflow-hidden bg-astro-800 border border-white/10 transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_0_30px_rgba(99,102,241,0.2)] hover:border-bio-accent/50 cursor-zoom-in"
                    onClick={() => setSelectedImage(img)}
                  >
                    <div className="w-full relative">
                      <img 
                        src={img.url} 
                        alt={img.prompt} 
                        className="w-full h-auto block opacity-90 group-hover:opacity-100 transition-opacity" 
                        loading="lazy"
                      />
                      <div className="absolute inset-0 bg-gradient-to-t from-astro-900 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
                      <div className="absolute top-2 left-2 w-2 h-2 border-t border-l border-white/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <div className="absolute bottom-2 right-2 w-2 h-2 border-b border-r border-white/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                    
                    <div className="absolute bottom-0 left-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-4 group-hover:translate-y-0 flex flex-col gap-3 pointer-events-none backdrop-blur-sm bg-astro-900/60 border-t border-white/10">
                      <p className="text-white text-[10px] font-mono line-clamp-2 leading-relaxed text-gray-300">{img.prompt}</p>
                      
                      <div className="flex gap-2 pointer-events-auto mt-1">
                        <button 
                          type="button"
                          onClick={(e) => { e.stopPropagation(); onDownload(img); }}
                          className="flex-1 bg-bio-primary/20 hover:bg-bio-primary/80 text-bio-accent hover:text-white py-2 rounded text-[10px] uppercase font-bold tracking-wider transition-all border border-bio-primary/30 hover:shadow-[0_0_10px_rgba(99,102,241,0.5)] cursor-pointer"
                        >
                          Save
                        </button>
                        <button 
                          type="button"
                          onClick={(e) => { e.stopPropagation(); onDelete(img.id); }}
                          className="w-8 h-8 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white rounded border border-red-500/20 flex items-center justify-center transition-all cursor-pointer"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {selectedImage && (
              <div 
                  className="fixed inset-0 z-[100] bg-astro-900/90 backdrop-blur-xl flex items-center justify-center p-4 md:p-8 animate-in fade-in duration-300"
                  onClick={() => setSelectedImage(null)}
              >
                  <button className="absolute top-6 right-6 text-gray-400 hover:text-white p-2 z-50 hover:rotate-90 transition-all duration-300 cursor-pointer">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>

                  <div 
                      className="relative max-w-7xl w-full flex flex-col md:flex-row gap-0 md:gap-8 rounded-3xl overflow-hidden md:overflow-visible" 
                      onClick={(e) => e.stopPropagation()}
                  >
                      <div className="flex-1 flex items-center justify-center p-2">
                          <img 
                              src={selectedImage.url} 
                              alt={selectedImage.prompt} 
                              className="max-w-full max-h-[85vh] object-contain shadow-[0_0_50px_rgba(99,102,241,0.2)] rounded-lg border border-white/5"
                          />
                      </div>

                      <div className="w-full md:w-80 glass-panel p-6 flex flex-col justify-between border-l border-white/10 rounded-2xl md:h-auto">
                        <div className="space-y-6">
                            <div>
                                <h3 className="text-bio-accent text-[10px] font-bold uppercase tracking-[0.2em] mb-3">Vision Prompt</h3>
                                <p className="text-gray-200 text-sm leading-relaxed font-light">{selectedImage.prompt}</p>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
                                <div>
                                    <h3 className="text-gray-500 text-[10px] font-bold uppercase tracking-[0.2em] mb-1">Frequency</h3>
                                    <p className="text-white text-xs font-mono">{selectedImage.styleName}</p>
                                </div>
                                <div>
                                    <h3 className="text-gray-500 text-[10px] font-bold uppercase tracking-[0.2em] mb-1">Ratio</h3>
                                    <p className="text-white text-xs font-mono">{selectedImage.aspectRatio}</p>
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 space-y-3 pt-6 border-t border-white/5">
                            <button 
                                type="button"
                                onClick={() => onDownload(selectedImage)}
                                className="w-full py-4 bg-white text-black font-display font-bold uppercase tracking-wider rounded-xl hover:bg-bio-accent hover:shadow-[0_0_20px_rgba(34,211,238,0.6)] transition-all flex items-center justify-center gap-2 cursor-pointer"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download
                            </button>
                            <button 
                                type="button"
                                onClick={() => { onDelete(selectedImage.id); setSelectedImage(null); }}
                                className="w-full py-3 bg-transparent text-red-400 font-bold uppercase tracking-wider text-xs rounded-xl hover:bg-red-900/20 hover:text-red-300 transition-colors border border-red-900/30 cursor-pointer"
                            >
                                Delete Artifact
                            </button>
                        </div>
                      </div>
                  </div>
              </div>
            )}
          </div>
        );
      };

      // --- APP ---
      const App = () => {
        const [hasApiKey, setHasApiKey] = useState(false);
        const [isCheckingKey, setIsCheckingKey] = useState(true);

        const [prompt, setPrompt] = useState('');
        const [selectedStyleId, setSelectedStyleId] = useState(STYLES[0].id);
        const [aspectRatio, setAspectRatio] = useState(AspectRatio.Square);
        
        const [referenceImageFile, setReferenceImageFile] = useState(null);
        const [referenceImagePreview, setReferenceImagePreview] = useState(null);

        const [isGenerating, setIsGenerating] = useState(false);
        const [generatedImages, setGeneratedImages] = useState([]);
        const [error, setError] = useState(null);

        useEffect(() => {
          async function checkKey() {
            try {
              if (window.aistudio && window.aistudio.hasSelectedApiKey) {
                const hasKey = await window.aistudio.hasSelectedApiKey();
                setHasApiKey(hasKey);
              } else {
                // If not in AI Studio, check if we have a manually injected key, otherwise require user to supply it via prompt logic later if we wanted
                // For this standalone, we default to false to show the connection screen
                setHasApiKey(false); 
              }
            } catch (e) {
              console.error("Error checking API key:", e);
            } finally {
              setIsCheckingKey(false);
            }
          }
          checkKey();
        }, []);

        const handleConnectApiKey = async () => {
          if (window.aistudio && window.aistudio.openSelectKey) {
            await window.aistudio.openSelectKey();
            setHasApiKey(true);
          } else {
            // Standalone Fallback: Ask user to paste key
            const userKey = window.prompt("Enter your Gemini API Key (from aistudio.google.com/api-keys):");
            if (userKey) {
              window.process.env.API_KEY = userKey;
              setHasApiKey(true);
            }
          }
        };

        useEffect(() => {
          const saved = localStorage.getItem('prisma_images');
          if (saved) {
            try {
              setGeneratedImages(JSON.parse(saved));
            } catch (e) {
              console.error("Failed to parse saved images", e);
            }
          }
        }, []);

        useEffect(() => {
          try {
            localStorage.setItem('prisma_images', JSON.stringify(generatedImages));
          } catch (e) {
            console.warn("Failed to save to local storage", e);
          }
        }, [generatedImages]);

        const handleImageSelect = (file) => {
          setReferenceImageFile(file);
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              setReferenceImagePreview(reader.result);
            };
            reader.readAsDataURL(file);
          } else {
            setReferenceImagePreview(null);
          }
        };

        const getBase64 = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
              const result = reader.result;
              const base64 = result.split(',')[1]; 
              resolve(base64);
            };
            reader.onerror = error => reject(error);
          });
        };

        const handleGenerate = async (e) => {
          e.preventDefault();
          if (!prompt.trim()) return;

          setIsGenerating(true);
          setError(null);

          try {
            let base64Image = undefined;
            let mimeType = undefined;

            if (referenceImageFile) {
              base64Image = await getBase64(referenceImageFile);
              mimeType = referenceImageFile.type;
            }

            const imageData = await generateImageWithGemini({
              prompt: prompt.trim(),
              styleId: selectedStyleId,
              aspectRatio,
              referenceImage: base64Image,
              referenceImageMimeType: mimeType
            });

            const newImage = {
              id: crypto.randomUUID(),
              url: imageData,
              prompt: prompt.trim(),
              styleName: STYLES.find(s => s.id === selectedStyleId)?.name || 'Custom',
              timestamp: Date.now(),
              aspectRatio: ASPECT_RATIOS.find(r => r.value === aspectRatio)?.label || aspectRatio,
            };

            setGeneratedImages(prev => [newImage, ...prev]);
          } catch (err) {
            if (err.message && (err.message.includes("Requested entity was not found") || err.message.includes("API key"))) {
              setHasApiKey(false);
              setError("Connection lost or invalid API key. Please re-authenticate.");
            } else {
              setError(err.message || "Something went wrong while generating the image.");
            }
          } finally {
            setIsGenerating(false);
          }
        };

        const handleDownload = (image) => {
          const link = document.createElement('a');
          link.href = image.url;
          link.download = `prisma-gen-${image.id}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const handleDelete = (id) => {
          setGeneratedImages(prev => prev.filter(img => img.id !== id));
        };

        const handleClearAll = () => {
          if (window.confirm("Delete all creations? This action cannot be reversed.")) {
            setGeneratedImages([]);
            localStorage.removeItem('prisma_images');
          }
        };

        if (isCheckingKey) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-astro-900 text-white">
              <div className="flex flex-col items-center gap-4">
                <div className="w-16 h-16 border-4 border-t-bio-accent border-r-transparent border-b-bio-secondary border-l-transparent rounded-full animate-spin"></div>
                <p className="font-mono text-bio-accent animate-pulse tracking-widest text-xs">INITIALIZING SYSTEMS...</p>
              </div>
            </div>
          );
        }

        if (!hasApiKey) {
          return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-astro-900 text-white p-6 relative overflow-hidden">
              <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-bio-primary/10 via-astro-900 to-astro-900"></div>
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-bio-secondary/5 rounded-full blur-[100px] animate-pulse-slow"></div>

              <div className="relative z-10 glass-panel p-10 md:p-14 rounded-3xl max-w-lg w-full text-center border border-white/10 shadow-[0_0_50px_rgba(99,102,241,0.15)] backdrop-blur-xl">
                
                <div className="w-20 h-20 mx-auto mb-8 bg-gradient-to-br from-bio-primary to-bio-secondary rounded-2xl flex items-center justify-center shadow-[0_0_20px_rgba(168,85,247,0.4)]">
                  <span className="text-4xl">âœ¨</span>
                </div>

                <h1 className="text-4xl font-display font-bold mb-3 bg-gradient-to-r from-white via-bio-accent to-bio-secondary bg-clip-text text-transparent">
                  PrismaGen AI
                </h1>
                <p className="text-gray-400 font-mono text-xs tracking-widest mb-8 uppercase">Celestial Edition</p>

                <div className="space-y-6">
                  <p className="text-gray-300 leading-relaxed font-light">
                    Welcome, traveler. To access the generative synthesis engine, a valid secure connection is required.
                  </p>

                  <button
                    onClick={handleConnectApiKey}
                    className="w-full py-4 relative group overflow-hidden rounded-xl bg-white text-black font-display font-bold uppercase tracking-widest hover:scale-[1.02] transition-transform duration-300 shadow-[0_0_20px_rgba(255,255,255,0.2)]"
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-bio-accent via-white to-bio-accent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <span className="relative z-10 flex items-center justify-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                      Initialize Neural Link
                    </span>
                  </button>

                  <p className="text-[10px] text-gray-500 font-mono">
                    Get your key at <a href="https://aistudio.google.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-bio-accent hover:underline decoration-bio-accent/50 underline-offset-4">aistudio.google.com</a>
                  </p>
                </div>
              </div>
              
              <div className="mt-8 text-[10px] text-gray-600 font-mono flex items-center gap-2">
                <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                SYSTEM LOCKED
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen text-gray-100 flex flex-col font-sans selection:bg-bio-accent/30 overflow-x-hidden animate-in fade-in duration-700">
            <header className="sticky top-0 z-50 glass-panel border-b-0 border-b-white/5">
              <div className="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="relative group">
                    <div className="absolute inset-0 bg-bio-secondary rounded-lg blur opacity-50 group-hover:opacity-100 transition-opacity animate-pulse-slow"></div>
                    <div className="relative w-10 h-10 rounded-xl bg-gradient-to-br from-bio-primary to-bio-secondary flex items-center justify-center border border-white/20">
                      <span className="text-2xl filter drop-shadow">âœ¨</span>
                    </div>
                  </div>
                  <h1 className="text-3xl font-display font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-bio-accent to-bio-secondary drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">
                    PrismaGen
                  </h1>
                </div>
                <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 backdrop-blur-md cursor-help" title="Connection Secure">
                  <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                  <span className="text-xs text-gray-300 font-mono tracking-wider">SYSTEM ONLINE</span>
                </div>
              </div>
              <div className="h-[1px] w-full bg-gradient-to-r from-transparent via-bio-secondary to-transparent opacity-50"></div>
            </header>

            <main className="flex-1 max-w-[1600px] mx-auto px-4 py-8 w-full flex flex-col lg:flex-row gap-8 relative z-10">
              <div className="lg:w-[400px] xl:w-[450px] flex-shrink-0 flex flex-col gap-6 animate-in slide-in-from-left duration-700">
                <form onSubmit={handleGenerate} className="flex flex-col gap-6">
                  
                  <ImageUploader 
                    previewUrl={referenceImagePreview}
                    onImageSelect={handleImageSelect}
                  />

                  <div className="relative group">
                    <div className="absolute -inset-0.5 bg-gradient-to-r from-bio-secondary to-bio-accent rounded-2xl blur opacity-20 group-hover:opacity-50 transition duration-500"></div>
                    <div className="relative">
                      <label className="text-xs font-bold text-bio-accent uppercase tracking-[0.2em] mb-2 block ml-1 text-shadow-glow">Prompt Protocol</label>
                      <textarea
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        placeholder="Describe your vision..."
                        className="w-full h-32 glass-input rounded-2xl p-4 text-white placeholder-gray-500 focus:outline-none resize-none transition-all font-light tracking-wide leading-relaxed"
                        required
                      />
                      <div className="absolute bottom-3 right-3 text-[10px] text-bio-accent font-mono opacity-60">
                        {prompt.length} CHARS
                      </div>
                    </div>
                  </div>

                  <div>
                    <label className="text-xs font-bold text-bio-accent uppercase tracking-[0.2em] mb-3 block ml-1 text-shadow-glow">
                      Visual Frequency
                    </label>
                    <div className="grid grid-cols-3 gap-3 h-52 overflow-y-auto pr-2 pb-2 custom-scrollbar">
                      {STYLES.map(style => (
                        <StyleCard
                          key={style.id}
                          style={style}
                          isSelected={selectedStyleId === style.id}
                          onSelect={setSelectedStyleId}
                        />
                      ))}
                    </div>
                  </div>

                  <Controls 
                    aspectRatio={aspectRatio}
                    setAspectRatio={setAspectRatio}
                  />

                  <button
                    type="submit"
                    disabled={isGenerating || !prompt.trim()}
                    className={`
                      group relative w-full py-4 rounded-xl font-display font-bold text-xl tracking-widest overflow-hidden
                      disabled:opacity-50 disabled:cursor-not-allowed
                      transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg
                      ${isGenerating ? 'bg-astro-700 text-gray-400' : 'text-white'}
                    `}
                  >
                    {!isGenerating && (
                      <div className="absolute inset-0 bg-gradient-to-r from-bio-primary via-bio-secondary to-bio-accent opacity-90 group-hover:opacity-100 transition-opacity"></div>
                    )}
                    
                    <div className="absolute inset-[1px] rounded-xl bg-astro-900/40 backdrop-blur-sm z-0 group-hover:bg-transparent transition-colors duration-300"></div>
                    
                    <span className="relative z-10 flex items-center justify-center gap-3 drop-shadow-md">
                      {isGenerating ? (
                        <>
                          <svg className="animate-spin h-5 w-5 text-bio-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          <span className="animate-pulse bg-gradient-to-r from-bio-accent to-white bg-clip-text text-transparent">SYNTHESIZING...</span>
                        </>
                      ) : (
                        <>
                          <span className="bg-gradient-to-r from-white to-gray-200 bg-clip-text text-transparent group-hover:text-white transition-colors">
                            {referenceImagePreview ? 'REMIX REALITY' : 'IGNITE PIXELS'}
                          </span>
                          <svg className="w-5 h-5 text-bio-accent group-hover:translate-x-1 transition-transform filter drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                          </svg>
                        </>
                      )}
                    </span>
                    
                    {!isGenerating && (
                      <div className="absolute top-0 -inset-full h-full w-1/2 z-20 block transform -skew-x-12 bg-gradient-to-r from-transparent to-white opacity-20 group-hover:animate-shimmer" />
                    )}
                  </button>
                  
                  {error && (
                    <div className="p-4 rounded-xl bg-red-900/20 border border-red-500/50 text-red-200 text-sm flex items-start gap-3 backdrop-blur-md shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                      <svg className="w-5 h-5 flex-shrink-0 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                      {error}
                    </div>
                  )}

                </form>
              </div>

              <div className="lg:w-2/3 flex flex-col min-h-[500px] animate-in slide-in-from-right duration-700 delay-100">
                <div className="flex-1 glass-panel rounded-3xl p-6 md:p-8 relative overflow-hidden border-t border-l border-white/10 border-b-0 border-r-0">
                  <div className="absolute top-0 right-0 w-64 h-64 bg-bio-secondary/10 rounded-full blur-[80px] pointer-events-none"></div>
                  <div className="absolute bottom-0 left-0 w-64 h-64 bg-bio-primary/10 rounded-full blur-[80px] pointer-events-none"></div>
                  
                  <Gallery 
                      images={generatedImages} 
                      onDownload={handleDownload}
                      onDelete={handleDelete}
                      onClearAll={handleClearAll}
                  />
                </div>
              </div>

            </main>
          </div>
        );
      };

      // --- RENDER ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>