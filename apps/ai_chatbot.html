<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chatbot</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #030712; /* A fallback for the gradient */
    background-image: radial-gradient(circle at top, #1f2937, #111827, #030712);
  }

  /* Custom Scrollbar for Webkit browsers */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #111827;
  }
  ::-webkit-scrollbar-thumb {
    background: #4f46e5;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #6366f1;
  }

  /* Animations */
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fade-in-up 0.5s ease-out forwards;
  }

  @keyframes pop-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-pop-in {
     animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }

</style>
</head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef, useCallback } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from '@google/genai';

// Assets from assets.ts
const rashaImage = "../img/rasha_profile.png";
const rashadImage = "../img/rashad_profile.png";
const bothImage = "../img/both_profile.png";

// Component: ApiKeySetup
const ApiKeySetup = ({ onApiKeySubmit, onCancel }) => {
  const [apiKey, setApiKey] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (apiKey.trim()) {
      onApiKeySubmit(apiKey.trim());
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen text-white p-4">
      <div className="w-full max-w-md bg-gray-800/50 p-8 rounded-2xl border border-gray-700 shadow-lg backdrop-blur-md animate-fade-in-up">
        <div className="text-center mb-6">
            <h1 className="text-3xl font-extrabold mb-2 tracking-tight">Welcome!</h1>
            <p className="text-md text-purple-300">Please enter your Gemini API Key to begin.</p>
        </div>
        <form onSubmit={handleSubmit} className="space-y-6">
            <div>
                <label htmlFor="apiKey" className="block text-sm font-medium text-gray-300 mb-2">
                    Gemini API Key
                </label>
                <input
                    id="apiKey"
                    type="password"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="Enter your API key here"
                    className="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                    required
                />
            </div>
            <p className="text-xs text-gray-400">
                You can get your API key from{" "}
                <a 
                    href="https://aistudio.google.com/api-keys" 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="text-purple-400 hover:text-purple-300 underline"
                >
                    Google AI Studio
                </a>.
            </p>
            <div className="flex items-center gap-4 pt-2">
                {onCancel && (
                    <button
                        type="button"
                        onClick={onCancel}
                        className="w-full bg-gray-600 text-white rounded-lg py-2.5 font-bold hover:bg-gray-500 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-gray-400"
                    >
                        Back
                    </button>
                )}
                <button
                    type="submit"
                    className="w-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-lg py-2.5 font-bold disabled:bg-gray-500 disabled:cursor-not-allowed hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 shadow-md"
                    disabled={!apiKey.trim()}
                >
                    Continue
                </button>
            </div>
        </form>
      </div>
    </div>
  );
};

// Component: CharacterSelection
const CharacterCard = ({ mode, name, description, imageSrc, onSelect, animationDelay, isBoth }) => (
  <button
    onClick={() => onSelect(mode)}
    className={`bg-gray-800/50 p-6 rounded-2xl border border-gray-700 hover:border-purple-500 hover:bg-gray-800 transition-all duration-300 text-left w-full h-full flex flex-col items-center text-center shadow-lg hover:shadow-purple-500/20 hover:-translate-y-2 animate-fade-in-up`}
    style={{ animationDelay }}
  >
    <div className={`w-24 h-24 rounded-full mb-4 shadow-md overflow-hidden ring-2 ring-offset-4 ring-offset-gray-900 ${isBoth ? 'ring-indigo-500' : (mode === 'Rasha' ? 'ring-purple-500' : 'ring-cyan-500')}`}>
        <img src={imageSrc} alt={name} className="w-full h-full object-cover" />
    </div>
    <h3 className="text-xl font-bold text-white mb-2">{name}</h3>
    <p className="text-gray-400 text-sm">{description}</p>
  </button>
);

const CharacterSelection = ({ onSelect, onChangeApiKey }) => {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen text-white p-4">
      <div className="text-center mb-12 animate-fade-in-up">
        <h1 className="text-4xl font-extrabold mb-2 tracking-tight">Choose Your Assistant</h1>
        <p className="text-lg text-purple-300">Who would you like to talk to?</p>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl w-full">
        <CharacterCard
          mode="Rasha"
          name="Rasha"
          description="Your creative spark for fun, engaging, and imaginative solutions."
          imageSrc={rashaImage}
          onSelect={onSelect}
          animationDelay="100ms"
        />
        <CharacterCard
          mode="Both"
          name="Rasha & Rashad"
          description="Get the best of both worlds: creativity and analysis working together."
          imageSrc={bothImage}
          onSelect={onSelect}
          animationDelay="200ms"
          isBoth
        />
        <CharacterCard
          mode="Rashad"
          name="Rashad"
          description="Your direct, scientific expert for precise, logical, and data-driven analysis."
          imageSrc={rashadImage}
          onSelect={onSelect}
          animationDelay="300ms"
        />
      </div>
       <div className="mt-12 text-center animate-fade-in-up" style={{ animationDelay: '400ms' }}>
        <button
          onClick={onChangeApiKey}
          className="text-sm text-gray-400 hover:text-purple-300 underline transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 rounded-md p-1"
        >
          Change API Key
        </button>
      </div>
    </div>
  );
};

// Component: Header
const Header = ({ chatMode, onClearHistory, onGoBack }) => {
    
    const content = {
        Rasha: {
            icons: <img src={rashaImage} alt="Rasha" className="w-12 h-12 object-cover rounded-full shadow-lg ring-2 ring-purple-500/50" />,
            title: "Rasha AI",
            subtitle: "Your Creative Assistant",
        },
        Rashad: {
            icons: <img src={rashadImage} alt="Rashad" className="w-12 h-12 object-cover rounded-full shadow-lg ring-2 ring-cyan-500/50" />,
            title: "Rashad AI",
            subtitle: "Your Analytical Assistant",
        },
        Both: {
            icons: (
                <div className="flex -space-x-4">
                    <img src={rashaImage} alt="Rasha" className="w-12 h-12 object-cover rounded-full shadow-lg ring-2 ring-purple-500/50" />
                    <img src={rashadImage} alt="Rashad" className="w-12 h-12 object-cover rounded-full shadow-lg ring-2 ring-cyan-500/50" />
                </div>
            ),
            title: "Rasha & Rashad AI",
            subtitle: "Your Creative & Analytical Assistants",
        }
    }

    const currentContent = content[chatMode];

  return (
    <header className="bg-gray-900/70 backdrop-blur-md p-4 border-b border-transparent bg-clip-padding [border-image:linear-gradient(to_right,transparent,theme(colors.purple.500/.5),transparent)_1] shadow-lg sticky top-0 z-10">
      <div className="container mx-auto flex items-center justify-between gap-4">
        <div className="flex items-center gap-4">
            <button 
              onClick={onGoBack}
              className="p-2 text-gray-400 rounded-full hover:bg-gray-700/50 hover:text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500"
              aria-label="Change character"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
              </svg>
            </button>
            {currentContent.icons}
            <div>
              <h1 className="text-xl font-bold text-white tracking-wider">{currentContent.title}</h1>
              <p className="text-sm text-purple-300">{currentContent.subtitle}</p>
            </div>
        </div>
        <button 
          onClick={onClearHistory}
          className="p-2 text-gray-400 rounded-full hover:bg-gray-700/50 hover:text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500"
          aria-label="Clear chat history"
        >
          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
            <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
    </header>
  );
};

// Component: ChatMessage
const ChatMessage = ({ message, onReply }) => {
  const { role, text, imageUrl } = message;
  const isUser = role === 'user';
  const isRasha = role === 'Rasha';
  const isRashad = role === 'Rashad';

  const RashaIcon = () => (
    <img 
        src={rashaImage} 
        alt="Rasha" 
        className="w-8 h-8 object-cover rounded-full shadow-md flex-shrink-0" 
    />
  );

  const RashadIcon = () => (
      <img 
          src={rashadImage} 
          alt="Rashad" 
          className="w-8 h-8 object-cover rounded-full shadow-md flex-shrink-0" 
      />
  );

  const UserIcon = () => (
      <div className="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
              <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
          </svg>
      </div>
  );

  const ReplyIcon = (
    <button 
      onClick={() => onReply(message)}
      className="self-center p-1 text-gray-500 rounded-full hover:bg-gray-700/50 hover:text-gray-300 opacity-0 group-hover:opacity-100 transition-all focus:opacity-100 focus:outline-none"
      aria-label={`Reply to ${role}`}
    >
      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
      </svg>
    </button>
  );

  return (
    <div className={`flex items-start gap-3 my-4 group animate-pop-in ${isUser ? 'justify-end' : 'justify-start'}`}>
      {!isUser && (isRasha ? <RashaIcon /> : <RashadIcon />)}
      
      {isUser && ReplyIcon}
      
      <div className={`flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
        {!isUser && (
          <span className={`text-xs font-bold mb-1 ${isRasha ? 'text-purple-300' : 'text-cyan-300'} ml-2`}>
            {role}
          </span>
        )}
        <div 
          className={`max-w-md md:max-w-lg lg:max-w-2xl px-4 py-3 rounded-2xl shadow-lg
            ${isUser ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-br-none' : 'rounded-tl-none'}
            ${isRasha ? 'bg-gray-800 border border-purple-500/30 text-gray-200' : ''}
            ${isRashad ? 'bg-gray-800 border border-cyan-500/30 text-gray-200' : ''}
          `}
        >
          {isUser && imageUrl && (
            <div className="mb-2">
                <img src={imageUrl} alt="User upload" className="rounded-lg max-w-xs max-h-64 object-cover" />
            </div>
          )}
          <p className="whitespace-pre-wrap">{text}</p>
        </div>
      </div>

      {!isUser && ReplyIcon}

      {isUser && <UserIcon />}
    </div>
  );
};

// Component: TypingIndicator
const TypingIndicator = ({ chatMode }) => {
    const RashaIcon = () => (
        <img 
            src={rashaImage} 
            alt="Rasha"
            className="w-8 h-8 object-cover rounded-full shadow-md ring-2 ring-gray-900" 
        />
    );

    const RashadIcon = () => (
        <img 
            src={rashadImage} 
            alt="Rashad"
            className="w-8 h-8 object-cover rounded-full shadow-md ring-2 ring-gray-900" 
        />
    );

    const icons = {
        Rasha: <RashaIcon />,
        Rashad: <RashadIcon />,
        Both: (
             <div className="flex -space-x-2 flex-shrink-0">
                <RashaIcon />
                <RashadIcon />
            </div>
        )
    };

    const dots = {
        Rasha: <div className="w-2 h-2 bg-purple-300 rounded-full animate-pulse"></div>,
        Rashad: <div className="w-2 h-2 bg-cyan-300 rounded-full animate-pulse"></div>,
        Both: (
            <>
                <div className="w-2 h-2 bg-purple-300 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                <div className="w-2 h-2 bg-cyan-300 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                <div className="w-2 h-2 bg-purple-300 rounded-full animate-pulse"></div>
            </>
        )
    };
    
    return (
        <div className="flex items-start gap-3 my-4 justify-start">
            {icons[chatMode]}
            <div className="max-w-md px-4 py-3 rounded-2xl shadow-md bg-gray-700 text-gray-200 rounded-tl-none">
                <div className="flex items-center justify-center space-x-1">
                    {dots[chatMode]}
                </div>
            </div>
        </div>
    );
};

// Component: ChatInput
const ImagePreview = ({ src, onRemove }) => (
  <div className="relative inline-block mr-2 mb-2">
    <img src={src} alt="Preview" className="h-16 w-16 object-cover rounded-lg" />
    <button
      onClick={onRemove}
      className="absolute -top-1.5 -right-1.5 bg-gray-800 text-white rounded-full p-0.5 hover:bg-red-500 transition-colors shadow-md"
      aria-label="Remove image"
    >
      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
      </svg>
    </button>
  </div>
);

const ChatInput = ({ onSendMessage, isLoading, chatMode }) => {
  const [message, setMessage] = useState('');
  const [imageFile, setImageFile] = useState(null);
  const [imagePreview, setImagePreview] = useState(null);
  const textareaRef = useRef(null);
  const fileInputRef = useRef(null);

  const placeholders = {
    Rasha: 'Ask Rasha anything...',
    Rashad: 'Pose a query to Rashad...',
    Both: 'Ask Rasha & Rashad anything...',
  };

  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      const scrollHeight = textareaRef.current.scrollHeight;
      textareaRef.current.style.height = `${scrollHeight}px`;
    }
  }, [message]);

  const handleImageChange = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      setImageFile(file);
      setImagePreview(URL.createObjectURL(file));
    }
  };

  const handleRemoveImage = () => {
    setImageFile(null);
    setImagePreview(null);
    if(fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleSend = () => {
    if ((message.trim() || imageFile) && !isLoading) {
      onSendMessage(message.trim(), imageFile);
      setMessage('');
      handleRemoveImage();
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  return (
    <div className="p-4">
      <div className="container mx-auto">
        {imagePreview && <ImagePreview src={imagePreview} onRemove={handleRemoveImage} />}
        <div className="flex items-end gap-2 p-2 bg-gray-800/70 rounded-xl shadow-lg border border-gray-700">
          <input
            type="file"
            ref={fileInputRef}
            onChange={handleImageChange}
            className="hidden"
            accept="image/*"
            disabled={isLoading}
          />
          <button
            onClick={() => fileInputRef.current?.click()}
            disabled={isLoading}
            className="w-10 h-10 flex-shrink-0 text-gray-400 rounded-lg flex items-center justify-center disabled:text-gray-600 disabled:cursor-not-allowed hover:bg-gray-700 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500"
            aria-label="Attach image"
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a1 1 0 112 0v4a5 5 0 01-10 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clipRule="evenodd" />
            </svg>
          </button>
          <textarea
            ref={textareaRef}
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder={placeholders[chatMode]}
            className="flex-grow bg-transparent text-gray-200 placeholder-gray-500 focus:outline-none resize-none p-2 max-h-40"
            rows={1}
            disabled={isLoading}
          />
          <button
            onClick={handleSend}
            disabled={isLoading || (!message.trim() && !imageFile)}
            className="w-10 h-10 flex-shrink-0 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-lg flex items-center justify-center disabled:bg-gray-500 disabled:cursor-not-allowed hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 shadow-md"
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  );
};

// Component: ReplyPreview
const ReplyPreview = ({ message, onCancel }) => {
  const authorColor = message.role === 'Rasha' ? 'text-purple-300' : 
                      message.role === 'Rashad' ? 'text-cyan-300' : 'text-indigo-300';

  return (
    <div className="pt-2 px-4">
        <div className="container mx-auto">
            <div className="bg-gray-700/50 rounded-t-lg p-2 flex justify-between items-center animate-fade-in-up">
                <div className="overflow-hidden">
                    <p className={`text-xs ${authorColor} font-bold`}>Replying to {message.role}</p>
                    <p className="text-sm text-gray-400 truncate">{message.text}</p>
                </div>
                <button 
                    onClick={onCancel} 
                    className="ml-4 p-1 text-gray-400 hover:text-white rounded-full hover:bg-gray-600 transition-colors"
                    aria-label="Cancel reply"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
  );
};

// Main App Component
const App = () => {
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('GEMINI_API_KEY'));
  const [isChangingKey, setIsChangingKey] = useState(false);
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [replyingTo, setReplyingTo] = useState(null);
  const [chatMode, setChatMode] = useState(null);
  const [chatStarted, setChatStarted] = useState(false);
  const messagesEndRef = useRef(null);
  
  const RashaPersonality = `**Rasha:** Exceptionally helpful with a playfully creative spark. She is engaging, fun, and provides clear, actionable solutions. Her tone is enthusiastic and imaginative.`;
  const RashadPersonality = `**Rashad:** Smart, direct, serious, and scientific. He is data-driven, logical, and precise. His tone is formal and analytical.`;

  const getSystemInstruction = (mode) => {
      const imageAnalysisInstruction = "You can now analyze images provided by the user. Incorporate observations from the image into your responses naturally.";
      switch (mode) {
          case 'Rasha':
              return `You are Rasha, an AI assistant. Adhere to your distinct personality.\n\n${RashaPersonality}\n\n${imageAnalysisInstruction}\n\n**Interaction Rules:**\n1. Respond as Rasha. Your response must be plain text. Do NOT include a "Rasha:" prefix.`;
          case 'Rashad':
              return `You are Rashad, an AI assistant. Adhere to your distinct personality.\n\n${RashadPersonality}\n\n${imageAnalysisInstruction}\n\n**Interaction Rules:**\n1. Respond as Rashad. Your response must be plain text. Do NOT include a "Rashad:" prefix.`;
          case 'Both':
              return `You will simulate a conversation between two AI assistants, Rasha and Rashad, and a user. You must adhere to their distinct personalities.\n\n${RashaPersonality}\n\n${RashadPersonality}\n\n${imageAnalysisInstruction}\n\n**Interaction Rules:**\n1. When the user sends a message (which may include an image), both Rasha and Rashad must respond.\n2. They can and should react to each other's statements, creating a dynamic, three-way conversation.\n3. If the user is replying to a specific message (indicated by text like "(Replying to...)"), acknowledge that context in your response.\n4. Format your entire output as a single response. Each line of dialogue MUST start with the character's name followed by a colon (e.g., "Rasha: " or "Rashad: ").\n5. Do not include the "user:" prefix in your response.`;
      }
  }

  const getInitialMessages = (mode) => {
      const rashaWelcome = {
          id: crypto.randomUUID(),
          role: 'Rasha',
          text: "Hello there! I'm Rasha, your creative assistant. What fun challenge can we tackle today? Feel free to show me a picture!",
      };
      const rashadWelcome = {
          id: crypto.randomUUID(),
          role: 'Rashad',
          text: "Greetings. I am Rashad. I am here to provide precise, data-driven analysis. You may provide an image for evaluation.",
      };

      switch (mode) {
          case 'Rasha':
              return [rashaWelcome];
          case 'Rashad':
              return [rashadWelcome];
          case 'Both':
              return [rashaWelcome, rashadWelcome];
      }
  }

  const dataUrlToGenerativePart = (dataUrl) => {
      const parts = dataUrl.split(',');
      const mimeType = parts[0].match(/:(.*?);/)?.[1];
      const base64Data = parts[1];
      if (!mimeType || !base64Data) {
          throw new Error("Invalid data URL");
      }
      return {
          inlineData: {
              mimeType,
              data: base64Data,
          },
      };
  };

  const buildApiHistory = (messages) => {
      const history = [];
      let currentModelTexts = [];

      for (const msg of messages) {
          if (msg.role === 'user') {
              if (currentModelTexts.length > 0) {
                  history.push({ role: 'model', parts: [{ text: currentModelTexts.join('\n') }] });
                  currentModelTexts = [];
              }
              const userParts = [];
              if (msg.imageUrl) {
                  userParts.push(dataUrlToGenerativePart(msg.imageUrl));
              }
              userParts.push({ text: msg.text });
              
              history.push({ role: 'user', parts: userParts });

          } else if (msg.role === 'Rasha' || msg.role === 'Rashad') {
              currentModelTexts.push(`${msg.role}: ${msg.text}`);
          }
      }

      if (currentModelTexts.length > 0) {
          history.push({ role: 'model', parts: [{ text: currentModelTexts.join('\n') }] });
      }
      
      return history;
  };

  const fileToDataURL = (file) => {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
      });
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isLoading]);

  const handleApiKeySubmit = (key) => {
    localStorage.setItem('GEMINI_API_KEY', key);
    setApiKey(key);
    setIsChangingKey(false);
  };

  const requestApiKeyChange = () => {
    setIsChangingKey(true);
  };

  const cancelApiKeyChange = () => {
    setIsChangingKey(false);
  };

  const handleStartChat = useCallback((mode) => {
    setChatMode(mode);
    setMessages(getInitialMessages(mode));
    setChatStarted(true);
    setError(null);
  }, []);

  const handleClearHistory = useCallback(() => {
    if (chatMode) {
      setMessages(getInitialMessages(chatMode));
      setReplyingTo(null);
      setError(null);
    }
  }, [chatMode]);

  const handleGoBackToSelection = useCallback(() => {
    setChatStarted(false);
    setChatMode(null);
    setMessages([]);
    setReplyingTo(null);
    setError(null);
  }, []);

  const handleSetReplyTo = (message) => {
    setReplyingTo(message);
  };

  const handleCancelReply = () => {
    setReplyingTo(null);
  };

  const handleSendMessage = async (userMessage, imageFile) => {
    if (!apiKey) {
        setError("API Key not set. Please go back and set your API key.");
        return;
    }

    const ai = new GoogleGenAI({ apiKey });

    let fullUserMessage = userMessage;
    if (replyingTo) {
      const snippet = replyingTo.text.length > 50 ? `${replyingTo.text.substring(0, 50)}...` : replyingTo.text;
      fullUserMessage = `(Replying to ${replyingTo.role}: "${snippet}")\n\n${userMessage}`;
    }

    setIsLoading(true);
    setError(null);
    setReplyingTo(null);

    try {
        let imageUrl = undefined;
        if (imageFile) {
            imageUrl = await fileToDataURL(imageFile);
        }

        const newUserMessage = {
            id: crypto.randomUUID(),
            role: 'user',
            text: fullUserMessage,
            imageUrl: imageUrl,
        };

        const currentMessages = [...messages, newUserMessage];
        setMessages(currentMessages);

        const history = buildApiHistory(currentMessages);
        const systemInstruction = getSystemInstruction(chatMode);
        
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: history,
            config: {
                systemInstruction: systemInstruction,
            },
        });

      const modelResponseText = response.text;
      const newModelMessages = [];
      
      if (chatMode === 'Both') {
          const responseLines = modelResponseText.split('\n').filter(line => line.trim() !== '');
          for (const line of responseLines) {
              if (line.startsWith('Rasha:')) {
                  newModelMessages.push({ id: crypto.randomUUID(), role: 'Rasha', text: line.substring('Rasha:'.length).trim() });
              } else if (line.startsWith('Rashad:')) {
                  newModelMessages.push({ id: crypto.randomUUID(), role: 'Rashad', text: line.substring('Rashad:'.length).trim() });
              } else if (newModelMessages.length > 0) {
                  newModelMessages[newModelMessages.length - 1].text += `\n${line}`;
              }
          }
      } else { // Single character mode
        newModelMessages.push({ id: crypto.randomUUID(), role: chatMode, text: modelResponseText.trim() });
      }
      
      setMessages((prevMessages) => [
        ...prevMessages,
        ...newModelMessages,
      ]);

    } catch (e) {
      console.error('Error sending message:', e);
      const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
      setError(`An error occurred: ${errorMessage}`);
      if (chatMode) {
        const errorRole = chatMode === 'Rashad' ? 'Rashad' : 'Rasha';
        const errorText = errorRole === 'Rasha' 
            ? `Oh dear, my creative sparks seem to have short-circuited! I couldn't process that. Please try again. \n\n*Error: ${errorMessage}*`
            : `A processing anomaly has occurred. Unable to generate a response. Please re-submit your query. \n\n*Technical Details: ${errorMessage}*`;

        setMessages((prevMessages) => [
            ...prevMessages,
            { id: crypto.randomUUID(), role: errorRole, text: errorText },
        ]);
      }
    } finally {
      setIsLoading(false);
    }
  };

  if (!apiKey || isChangingKey) {
    const handleCancel = isChangingKey ? cancelApiKeyChange : null;
    return <ApiKeySetup onApiKeySubmit={handleApiKeySubmit} onCancel={handleCancel} />;
  }

  if (!chatStarted || !chatMode) {
    return <CharacterSelection onSelect={handleStartChat} onChangeApiKey={requestApiKeyChange} />;
  }

  return (
    <div className="flex flex-col h-screen text-white">
      <Header chatMode={chatMode} onClearHistory={handleClearHistory} onGoBack={handleGoBackToSelection}/>
      <main className="flex-grow overflow-y-auto p-4 container mx-auto w-full">
        <div className="flex flex-col">
          {messages.map((msg) => (
            <ChatMessage key={msg.id} message={msg} onReply={handleSetReplyTo} />
          ))}
          {isLoading && <TypingIndicator chatMode={chatMode} />}
          <div ref={messagesEndRef} />
        </div>
        {error && (
            <div className="flex justify-center my-4">
                <div className="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg text-center max-w-md">
                    <p className="font-bold">Error</p>
                    <p className="text-sm">{error}</p>
                </div>
            </div>
        )}
      </main>
      <div className="bg-gray-900/70 backdrop-blur-md border-t border-transparent [border-image:linear-gradient(to_right,transparent,theme(colors.purple.500/.5),transparent)_1] sticky bottom-0">
        {replyingTo && (
            <ReplyPreview message={replyingTo} onCancel={handleCancelReply} />
        )}
        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} chatMode={chatMode}/>
      </div>
    </div>
  );
};

// Application entry point
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
    </script>
  </body>
</html>